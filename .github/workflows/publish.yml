name: Publish Release

on:
  push:
    tags:
      - 'v*' # Trigger on tags like v1.0.0, v1.0.1, etc.
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g., v1.0.6)'
        required: true
        default: 'v1.0.6'

jobs:
  build-and-release:
    runs-on: ubuntu-24.04
    permissions:
      contents: write   # GitHub Release æ­¥éª¤éœ€è¦

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.tag || github.ref }}

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'microsoft'

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Build with Gradle
        run: ./gradlew build -Pmod_version=${GITHUB_REF_NAME#v}

      - name: Smart Multi-Platform Publish
        run: |
          # å¯ç”¨æ‰©å±•é€šé…ç¬¦æ”¯æŒ
          shopt -s extglob
          
          # åˆå§‹åŒ–å¹³å°çŠ¶æ€
          github_success=false
          modrinth_success=false
          curseforge_success=false
          
          # å¤±è´¥è®¡æ•°å™¨ï¼ˆæ¯ä¸ªå¹³å°ç‹¬ç«‹ï¼‰
          github_failures=0
          modrinth_failures=0
          curseforge_failures=0
          
          # æœ€å¤§å¾ªç¯æ¬¡æ•°
          max_cycles=5
          cycle=1
          
          echo "ğŸš€ Starting smart multi-platform publish (max $max_cycles cycles)"
          
          while [ $cycle -le $max_cycles ]; do
            echo "ğŸ”„ Cycle $cycle / $max_cycles"
            
            all_success=true
            
            # GitHub å‘å¸ƒ
            if [ "$github_success" = false ]; then
              echo "ğŸ“¤ Attempting GitHub publish..."
              if gh release create ${{ github.ref_name }} \
                --title "${{ github.ref_name }}" \
                --notes-file CHANGELOG.md \
                --draft=false \
                --prerelease=false \
                build/libs/!(*-@(dev|sources|javadoc)).jar; then
                echo "âœ… GitHub publish successful"
                github_success=true
                github_failures=0
              else
                echo "âŒ GitHub publish failed"
                github_failures=$((github_failures + 1))
                all_success=false
                if [ $github_failures -ge 2 ]; then
                  delay=$((2 ** (github_failures - 1) * 10))
                  echo "â³ GitHub consecutive failures: $github_failures, waiting ${delay}s..."
                  sleep $delay
                fi
              fi
            else
              echo "âœ… GitHub already successful, skipping"
            fi
            
            # Modrinth å‘å¸ƒ
            if [ "$modrinth_success" = false ]; then
              echo "ğŸ“¤ Attempting Modrinth publish..."
              if ./gradlew modrinth \
                --stacktrace \
                -Pmodrinth.token=${{ secrets.MODRINTH_TOKEN }} \
                -Pmodrinth.id="item-info-copier" \
                -Pmodrinth.featured=true \
                -Pmodrinth.changelog.file=CHANGELOG.md; then
                echo "âœ… Modrinth publish successful"
                modrinth_success=true
                modrinth_failures=0
              else
                echo "âŒ Modrinth publish failed"
                modrinth_failures=$((modrinth_failures + 1))
                all_success=false
                if [ $modrinth_failures -ge 2 ]; then
                  delay=$((2 ** (modrinth_failures - 1) * 10))
                  echo "â³ Modrinth consecutive failures: $modrinth_failures, waiting ${delay}s..."
                  sleep $delay
                fi
              fi
            else
              echo "âœ… Modrinth already successful, skipping"
            fi
            
            # CurseForge å‘å¸ƒ
            if [ "$curseforge_success" = false ]; then
              echo "ğŸ“¤ Attempting CurseForge publish..."
              if ./gradlew curseforge \
                --stacktrace \
                -Pcurseforge.token=${{ secrets.CURSEFORGE_TOKEN }} \
                -Pcurseforge.id="1435524" \
                -Pcurseforge.changelog.file=CHANGELOG.md; then
                echo "âœ… CurseForge publish successful"
                curseforge_success=true
                curseforge_failures=0
              else
                echo "âŒ CurseForge publish failed"
                curseforge_failures=$((curseforge_failures + 1))
                all_success=false
                if [ $curseforge_failures -ge 2 ]; then
                  delay=$((2 ** (curseforge_failures - 1) * 10))
                  echo "â³ CurseForge consecutive failures: $curseforge_failures, waiting ${delay}s..."
                  sleep $delay
                fi
              fi
            else
              echo "âœ… CurseForge already successful, skipping"
            fi
            
            # æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å¹³å°éƒ½æˆåŠŸ
            if [ "$all_success" = true ]; then
              echo "ğŸ‰ All platforms published successfully!"
              break
            fi
            
            cycle=$((cycle + 1))
          done
          
          # æ£€æŸ¥æœ€ç»ˆçŠ¶æ€
          if [ "$github_success" = false ] || [ "$modrinth_success" = false ] || [ "$curseforge_success" = false ]; then
            echo "âŒ Some platforms failed after $max_cycles cycles"
            echo "GitHub: $github_success, Modrinth: $modrinth_success, CurseForge: $curseforge_success"
            exit 1
          fi